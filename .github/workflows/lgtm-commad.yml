# ============================================================================
# LGTM Command Worker
# ============================================================================
# Handles /lgtm commands from chatops-dispatcher
#
# Flow:
# 1. User comments /lgtm on PR
# 2. chatops-dispatcher catches it and dispatches here
# 3. This workflow:
#    - Verifies user is in OWNERS file
#    - Checks if PR is draft
#    - Checks for blocking labels (hold/wip/do-not-merge)
#    - Adds lgtm label
#    - Waits 5 minutes (allows gatekeeper to run)
#    - Enables auto-merge
# ============================================================================

name: LGTM Command Worker
on:
  repository_dispatch:
    types: [lgtm-command]

jobs:
  apply-lgtm:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # STEP 1: AUTHORIZATION - Verify user is in OWNERS file
      # -----------------------------------------------------------------------
      # Only users listed as approvers in OWNERS can use /lgtm
      # This prevents unauthorized users from approving PRs
      - name: Check Permissions
        id: check
        env:
          ACTOR: ${{ github.event.client_payload.github.actor }}
        run: |
          if grep -q "^\s*-\s*$ACTOR\s*$" OWNERS; then
            echo "authorized=true" >> $GITHUB_OUTPUT
          else
            echo "::error::User $ACTOR is not an approver."
            exit 1
          fi

      # -----------------------------------------------------------------------
      # STEP 2: VALIDATION - Check if PR is in draft mode
      # -----------------------------------------------------------------------
      # Draft PRs cannot be approved - they must be marked ready for review
      # This prevents accidental approval of incomplete work
      - name: Check Draft Status
        if: steps.check.outputs.authorized == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.client_payload.github.payload.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          IS_DRAFT=$(gh pr view $PR_NUMBER --repo "$REPO" --json isDraft --jq '.isDraft')
          if [ "$IS_DRAFT" = "true" ]; then
            echo "::error::Cannot LGTM a Draft PR."
            gh issue comment $PR_NUMBER --repo "$REPO" --body "⚠️ **LGTM Failed**: PR is a Draft."
            exit 1
          fi

      # -----------------------------------------------------------------------
      # STEP 3: BLOCKING LABELS - Check for hold/wip/do-not-merge
      # -----------------------------------------------------------------------
      # If any blocking label exists, fail immediately
      # This prevents approving PRs that are explicitly marked as not ready
      - name: Check for Blocking Labels
        if: steps.check.outputs.authorized == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.client_payload.github.payload.issue.html_url }}
        run: |
          LABELS=$(gh pr view "$PR_URL" --json labels --jq '.labels[].name')
          if echo "$LABELS" | grep -Eiq "^(hold|wip|do-not-merge)$"; then
            echo "::error::PR is blocked by label."
            gh issue comment "$PR_URL" --body "  **Merge Blocked**: Please remove the \`hold\`, \`wip\`, or \`do-not-merge\` label before merging."
            exit 1
          fi

      # -----------------------------------------------------------------------
      # STEP 4: APPLY LGTM - Add label, wait, then enable auto-merge
      # -----------------------------------------------------------------------
      # 1. Add lgtm label (triggers gatekeeper to validate)
      # 2. Wait 5 minutes (gives time for:
      #    - Gatekeeper to run and validate
      #    - CI checks to start
      #    - Early failure detection)
      # 3. Enable auto-merge (PR will merge when all checks pass)
      - name: Apply Label & Merge
        if: steps.check.outputs.authorized == 'true'
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
          PR_NUMBER: ${{ github.event.client_payload.github.payload.issue.number }}
          PR_URL: ${{ github.event.client_payload.github.payload.issue.html_url }}
        run: |
          # Apply lgtm label
          if ! gh issue edit "$PR_NUMBER" --add-label "lgtm"; then
            echo "::error::Failed to add lgtm label"
            gh issue comment "$PR_URL" --body "  **Error**: Failed to add lgtm label to the PR."
            exit 1
          fi

          echo "Waiting 5 minutes before setting auto-merge..."
          echo "Current time: $(date)"
          sleep 300
          echo "Wait completed at: $(date)"

          # Enable auto-merge with error handling
          if ! gh pr merge --auto --squash "$PR_URL" 2>&1 | tee merge_output.txt; then
            echo "::error::Failed to enable auto-merge"
            ERROR_MSG=$(cat merge_output.txt)
            gh issue comment "$PR_URL" --body "  **Auto-merge failed**: Could not enable auto-merge on this PR.

          **Error details:**
          \`\`\`
          $ERROR_MSG
          \`\`\`

          **Common reasons:**
          - Branch protection rules not satisfied
          - Required status checks not passing
          - Merge conflicts present
          - Auto-merge not enabled for this repository

          Please check the PR status and try again, or merge manually."
            exit 1
          fi

          echo "✅ Auto-merge enabled successfully"
          gh issue comment "$PR_URL" --body "✅ **LGTM**: Auto-merge has been enabled. The PR will merge automatically once all checks pass."


      # -----------------------------------------------------------------------
      # STEP 5: FEEDBACK - Add reaction to comment
      # -----------------------------------------------------------------------
      # Visual confirmation that the command was processed successfully
      - name: React Rocket
        if: success()
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.client_payload.github.payload.comment.id }}
          reactions: rocket
