name: "Prow Automation"

on:
  repository_dispatch:
    types: [lgtm-command]
  pull_request:
    types: [labeled, unlabeled, synchronize, opened, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # --- JOB 1: HANDLE /lgtm COMMAND ---
  # Triggered by repository_dispatch from chatops-dispatcher
  lgtm-command:
    if: github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      # --- STEP 1: VERIFY APPROVER (OWNERS File) ---
      - name: Verify User in OWNERS
        id: check_perm
        env:
          ACTOR: ${{ github.event.client_payload.github.actor }}
        run: |
          echo "DEBUG: Checking authorization for user: '$ACTOR'"
          echo "DEBUG: GITHUB_OUTPUT file: $GITHUB_OUTPUT"

          if [ ! -f "OWNERS" ]; then
            echo "ERROR: OWNERS file not found."
            echo "authorized=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          APPROVERS=$(yq '.approvers[]' OWNERS)
          echo "DEBUG: Approvers from OWNERS file:"
          echo "$APPROVERS"

          if echo "$APPROVERS" | grep -Fiqx "$ACTOR"; then
            echo "DEBUG: ‚úì User '$ACTOR' IS in approvers list"
            echo "authorized=true" >> "$GITHUB_OUTPUT"
          else
            echo "DEBUG: ‚úó User '$ACTOR' is NOT in approvers list"
            echo "authorized=false" >> "$GITHUB_OUTPUT"
          fi

          echo "DEBUG: Final output value:"
          grep "authorized" "$GITHUB_OUTPUT" || echo "ERROR: No authorized output found!"

      # --- STEP 2: CHECK BLOCKING LABELS ---
      - name: Check for Blocking Labels
        if: steps.check_perm.outputs.authorized == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.client_payload.github.payload.issue.html_url }}
        run: |
          LABELS=$(gh pr view "$PR_URL" --json labels --jq '.labels[].name')
          if echo "$LABELS" | grep -Eiq "^(hold|wip|do-not-merge)$"; then
            echo "::error::PR is blocked by label."
            gh issue comment "$PR_URL" --body "‚ö†Ô∏è **Merge Blocked**: Please remove the \`hold\`, \`wip\`, or \`do-not-merge\` label before merging."
            exit 1
          fi

      # --- STEP 3: MERGE (Only runs if Step 2 passed) ---
      - name: Apply Label & Merge
        if: steps.check_perm.outputs.authorized == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.client_payload.github.payload.issue.number }}
          PR_URL: ${{ github.event.client_payload.github.payload.issue.html_url }}
        run: |
          # Apply lgtm label
          if ! gh issue edit "$PR_NUMBER" --add-label "lgtm"; then
            echo "::error::Failed to add lgtm label"
            gh issue comment "$PR_URL" --body "‚ö†Ô∏è **Error**: Failed to add lgtm label to the PR."
            exit 1
          fi

          echo "Waiting 5 minutes before setting auto-merge..."
          echo "Current time: $(date)"
          sleep 300
          echo "Wait completed at: $(date)"

          # Enable auto-merge with error handling
          if ! gh pr merge --auto --squash "$PR_URL" 2>&1 | tee merge_output.txt; then
            echo "::error::Failed to enable auto-merge"
            ERROR_MSG=$(cat merge_output.txt)
            gh issue comment "$PR_URL" --body "‚ö†Ô∏è **Auto-merge failed**: Could not enable auto-merge on this PR.

          **Error details:**
          \`\`\`
          $ERROR_MSG
          \`\`\`

          **Common reasons:**
          - Branch protection rules not satisfied
          - Required status checks not passing
          - Merge conflicts present
          - Auto-merge not enabled for this repository

          Please check the PR status and try again, or merge manually."
            exit 1
          fi

          echo "‚úÖ Auto-merge enabled successfully"
          gh issue comment "$PR_URL" --body "‚úÖ **LGTM**: Auto-merge has been enabled. The PR will merge automatically once all checks pass."

      # --- STEP 4: FEEDBACK ---
      - name: React with Rocket
        if: steps.check_perm.outputs.authorized == 'true'
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.client_payload.github.payload.comment.id }}
          reactions: rocket

      - name: Notify Unauthorized
        if: steps.check_perm.outputs.authorized == 'false'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.client_payload.github.payload.issue.number }}
          body: "üö´ **Authorization Failed**: You are not an approver."
          reactions: confused

  # --- JOB 2: THE GATEKEEPER ---
  # This job acts as a Required Status Check.
  # It only passes if lgtm is present AND no blockers exist.
  gatekeeper:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate Prow Logic
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # Fetch current labels directly from API for the most up-to-date state
          LABELS=$(gh pr view $PR_NUMBER --repo "$REPO" --json labels --jq '.labels[].name')

          echo "Current Labels: $LABELS"

          # 1. Check for Blockers
          if echo "$LABELS" | grep -E -q 'hold|wip|do-not-merge'; then
            echo "::error::BLOCKED: 'hold', 'wip', or 'do-not-merge' label detected."
            exit 1
          fi

          # 2. Check for LGTM
          if ! echo "$LABELS" | grep -E -q 'lgtm'; then
            echo "::error::BLOCKED: Missing 'lgtm' label."
            exit 1
          fi

          echo "‚úÖ Safety checks passed: lgtm label present and no blocking labels."
