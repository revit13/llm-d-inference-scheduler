name: Reset LGTM on Update
on:
  pull_request:
    types: [synchronize] # Trigger whenever a new commit is pushed

jobs:
  reset-status:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Stop the Merge & Remove Label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          echo "New commit detected. Resetting PR status..."
          
          # 1. CRITICAL: Cancel the auto-merge
          # This stops GitHub from merging the PR even if tests pass.
          gh pr merge "$PR_URL" --disable-auto || true
          echo "Auto-merge disabled."

          # 2. Remove the LGTM label (Visual reset)
          # This forces the user to ask for /lgtm again.
          gh issue edit "$PR_URL" --remove-label "lgtm" || true
          echo "Label removed."
